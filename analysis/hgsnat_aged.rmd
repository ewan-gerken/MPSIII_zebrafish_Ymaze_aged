---
title: "hgsnat aged y-maze"
author: "Ewan Gerken"
date: "2023-02-10"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  autodep = TRUE,
  echo = TRUE, 
  warning = FALSE,
  message = FALSE,
  fig.align = "center", 
  fig.retina = 1,
  out.width ="100%", 
  out.height = "100%"
)
```

```{r packages}
library(tidyverse)
library(readxl)
library(here)
library(magrittr)
library(scales)
library(readxl)
library(ggpubr)
library(ggeasy)
library(ggfortify)
library(ggbeeswarm)
library(ggforce)
library(ggrepel)
library(kableExtra)
library(ggtext)

# stat analysis
library(broom)
library(lme4)
library(performance)
library(car)
library(emmeans)
library(glmmTMB)
library(MASS)

# set the default theme for ggplot as theme_bw
theme_set(theme_bw())
```

# Introduction. 

Note: this analysis below is missing 10 fish from the family which I don't have genotypes for yet, I just want an initial look at the data because I still have plenty of fish with genotypes.



Each fish was isolated in the behavioru testing room for 45 mins prior to behaviour testing. It was then placed in the mazes alone for 1 hour. Raw data was collected, and metadata was recorded (i.e. sex, time, etc). These raw data spreadsheets were batch processed in the BatchProcess R script in the `code` folder to produce the `final_data` object. This object contains the tetragram frequencies and total number of turns. Note that fish were genotyped after data collection so that we are blinded from any observer bias until after raw data collection.

While collecting behaviorual data, the machine ran out of memory and data stop being collected for the trial starting at `2.59pm` (between 30 and 45 mins into the test). So I will omit these fish from the analysis. 

```{r}
# read in the processed data and metadata
meta <- read_xlsx("/Users/admin/Desktop/R projects/MPSIII_zebrafish_Ymaze-main/data/metadata/hgsnat aged behavioural metadata.xlsx") %>% 
  mutate(fish_id = as.factor(fish_id),
         start_time = as.factor(start_time),
         tank = as.factor(tank),
         sex = as.factor(sex),
         zantiks_unit = as.factor(zantiks_unit),
         arena_position = as.factor(arena_position),
         time_rounded = as.factor(time_rounded),
         genotype = factor(genotype, levels = c("wt", "het", "hom"))
  )

final_data <- read_csv("/Users/admin/Desktop/R projects/MPSIII_zebrafish_Ymaze-main/data/processed_data/hgsnat/aged/final_output.csv") %>% 
  dplyr::select(-1) %>% 
  mutate(fish_id = factor(fish_id)) %>% 
  left_join(meta) %>% 
  dplyr::filter(genotype %in% c("wt", "het", "hom"))
#view(final_data)

# make an object which converts the final data to long format. for easier plotting in ggplot
final_data_long <- final_data %>%
  gather(key = "tetras", value = "Count", # convert to long format
         grep("[L|R]{4}", 
              colnames(.))
         )

# also make an object which sums the tetragrams over the hour
final_data_summedoverbins <- final_data %>%
  gather(key = "tetras", value = "Count", # convert to long format
         grep("[L|R]{4}", # select the columns which contain a L or a R four times
              colnames(.))
         ) %>% 
  group_by(fish_id, tetras) %>% 
  mutate(x = sum(Count)) %>% # sum the tetragram counts per fish_id
  dplyr::select(colnames(meta), tetras, x) %>% 
  unique
```

# assess whether tracking worked correctly. 

When assessing behavioural tracking data, it is important to check whether the tracking of your animal was correct. I saved the tracking videos for watching, but also I will check the data to see whether any abnormalities are present.

From my previous experience with zebrafish in a y-maze, fish do not make more than 200 turns per 10 mins in the Y-maze. Plotting out the total number of turns per fish per 10 minute bin show a couple of fish looking very busy. 

```{r}
final_data %>% 
  ggplot(aes(x = fish_id, y = total_turns)) +
  geom_col(aes(fill = total_turns >= 200)) + 
  geom_label_repel(aes(label = fish_id), 
                   data = . %>% 
                     dplyr::filter(total_turns >= 200)) +
  facet_wrap(~bin) +
  scale_fill_manual(values = c("grey50", "red", "green"))
```

```{r}
foi <- c("91", "105")
final_data %>% 
  ggplot(aes(x = fish_id, y = total_turns)) +
  geom_col(aes(fill = fish_id %in% foi)) + 
  geom_label_repel(aes(label = fish_id), 
                   data = . %>% 
                     dplyr::filter(fish_id %in% foi)) +
  facet_wrap(~bin) +
  scale_fill_manual(values = c("grey50", "red", "green"))
```

# removing fish

```{r}
# define fish which had the tracking issues
fish2omit_geno <- meta %>%
   dplyr::filter(is.na(genotype)) %>%
   pull(fish_id)
 fish2omit_keepCol <- meta %>%
   dplyr::filter(keep== "N") %>%
   pull(fish_id)
fish2omit <- c(fish2omit_geno, fish2omit_keepCol) %>%
  unique()

# Manually remove fish

fish2omit <- c(fish2omit, "8")

# remove them. Can also use this to remove fish which I had already decided to exclude based on events/observations before or during the test (see 'notes' column of metadata spreadsheet. I change the 'keep' column of these to "N", I then have code above that will filter these. For more outlier fish I come across in my analysis, I can use the manual remove line of code I wrote above.

final_data %<>%
  dplyr::filter(!(fish_id %in%fish2omit))

final_data_long%<>%
  dplyr::filter(!(fish_id %in% fish2omit))

final_data_summedoverbins%<>%
  dplyr::filter(!(fish_id %in% fish2omit))
```

# genotype proportions

Generally, a relatively equal number of fish per genotype treatment should be tested for a nice experiment.  There are less homs in the iron treated fish. However, since I was blinded to genotype this could just be by chance. 

```{r}
hgsnatagedgenoproportions <- 
  final_data %>% 
  dplyr::select(colnames(meta)) %>% 
  dplyr::distinct() %>% 
  group_by(genotype) %>% 
  mutate(n = n()) %>% 
  ggplot(aes(x = genotype)) +
  geom_bar(aes(fill = genotype), 
           colour = "black", alpha = 0.7) +
  scale_y_continuous(limits = c(0,50), breaks = seq(0,50,5)) +
  scale_fill_viridis_d() + 
  theme(legend.position = "bottom") +
  theme(plot.title = element_markdown(size = 14, hjust = 0.5)) +
  labs(title = "***hgsnat*** Y-maze genotype proportions",
       y = "Number of fish", 
       x = "")

saveRDS(hgsnatagedgenoproportions, "data/R objects/supps/hgsnatagedgenoproportions.rds")
```


# Locomotor defect
## Overall total number of turns (summed over the whole hour)

The first readout you can obtain from a y-maze test is a locomotor phenotype. The zantiks machine is currently set up to measure the number of turns (i.e. zone changes), I will see if this is changed across genotypes and treatments. I can re-analyse the video data at a later date to formally measure total distance travelled. 

I will first look at the total number of turns summed over the whole hour.  It doesnt overerly look like there is much difference here in the whole hour. Below is a plot where I can highlight fish of interest in the raw data
```{r}
final_data_summedoverbins %>%
  ungroup() %>%
  group_by(fish_id) %>%
  mutate(total_turns = sum(x)) %>%
  dplyr::select(colnames(meta), total_turns) %>% 
  unique() %>% 
  ggplot(aes(x = genotype,y = total_turns)) +
  geom_violin(aes(fill = genotype),
               alpha = 0.5) +
  geom_boxplot(aes(colour = genotype),
               fill = NA, 
               width = 0.25,
               colour= "black") +
  geom_label_repel(aes(label = fish_id),
                   data = . %>%
                     dplyr::filter(fish_id %in% foi)) +
  scale_fill_viridis_d(option = "viridis") +
  scale_colour_viridis_d(option = "viridis") +
  # geom_point(data = final_data_summedoverbins %>% filter(fish_id == "7"), color = "red") +
  geom_quasirandom(aes(colour = fish_id %in% foi), size = 2) +
  scale_colour_manual(values = c("black", "red")) +
  labs(y = "Total number of turns", 
       title = "Total number of turns performed by fish in the Y-maze in 1 hour")

```

# raw turns plot for publication

```{r}
hgsnataged_raw_turns <- 
  final_data_summedoverbins %>%
  ungroup() %>%
  group_by(fish_id) %>%
  mutate(total_turns = sum(x)) %>%
  dplyr::select(colnames(meta), total_turns) %>% 
  unique %>% 
  ggplot(aes(x = genotype,y = total_turns)) +
  geom_violin(aes(fill = genotype),
               alpha = 0.5) +
  geom_boxplot(aes(colour = genotype),
               fill = NA,
               width = 0.25,
               colour= "black") +
  theme(plot.title = element_markdown(size = 14, hjust = 0.5)) +
  scale_y_continuous(limits = c(0,1400), breaks = seq(0,1400,250)) +
  geom_quasirandom(size = 2) +
  scale_fill_viridis_d(option = "viridis") +
  scale_colour_viridis_d(option = "viridis") +
  labs(y = "Total number of turns in 1 hour", 
       title = "Total turns by ***hgsnat^G577Sfs^*** fish")

saveRDS(hgsnataged_raw_turns, "data/R objects/supps/hgsnataged_raw_turns.rds")

```

I also want to look at whether there is a batch effect of test. There were a total of 12 tests (start times indicated in the plot) performed in one of two zantiks units (139 and 146). Each test contained 8 fish which were randomly assigned. A bit of variation is observed between start times, but this would be expected considering they are performed throughoutthe day, and have had sligtly different environmental conditions (e.g. ,vibrations from the construction, people talking out in the hall etc), as well as circadian differences. 

Ewan: possibly looks like # of turns is dipping slightly towards end of the day, but there's so much variation that this is unlikely to be significant. Will be interesting to look at my hgsnat family in this plot since there were more fish and I was testing later in the day.

```{r}
final_data_summedoverbins %>%
  ungroup() %>%
  group_by(fish_id) %>%
  mutate(total_turns = sum(x)) %>%
  ungroup %>% 
  dplyr::select(colnames(meta), total_turns) %>%
  unique %>%
  ggplot(aes(x = `start_time`, y = total_turns)) +
  geom_boxplot(aes(fill = `start_time`),
               outlier.shape = NA,
               width = 0.25,
               alpha = 0.5,
               colour= "black") +
  geom_jitter(aes(colour = `start_time`),
              size = 3) +
  labs(y = "Total number of turns", 
       title = "Total number of turns performed by fish in the Y-maze in 1 hour", 
       subtitle = "According to start time of day of the test")
```

I also had a look at whether the Genotype and could explain some of the apparent variation within tests. This plot is a bit difficult to interpret quickly. No clear pattern to see, some differences between genotypes over the course of the day are apparent.

```{r}
final_data_summedoverbins %>%
  ungroup() %>%
  group_by(fish_id) %>%
  mutate(total_turns = sum(x)) %>%
  dplyr::select(colnames(meta), total_turns) %>%
  unique %>%
  ggplot(aes(x = genotype, y = total_turns)) +
  geom_violin(aes(fill = genotype),
               alpha = 0.5) +
  geom_boxplot(aes(colour = genotype),
               fill = NA,
               width = 0.25,
               colour= "black") +
  scale_fill_viridis_d(option = "viridis") +
  scale_colour_viridis_d(option = "viridis") +
  facet_wrap(~start_time) +
  labs(y = "Total number of turns", 
       title = "Total number of turns performed by fish in the Y-maze in 1 hour", 
       subtitle = "According to start time of day of the test")
```

## statistical test

To test whether the Genotype has a significant effect overall on the total number of turns, I fitted the summed over bins data to a negative binomial generalised linear mixed effect model (negative binomial).

Since the start time of the test doesnt have a logical pattern (i.e. more active in morning), I've included it in the model as a random effect.

Ewan: tried to remove sections of code referring to treatment, and changed any relevant input or column names, however was getting an error: Error in xml_children(x)[[search]] : subscript out of bounds



```{r}
# also look at the total number of turns (without the bins)
glm_timebyturns2 <- final_data_summedoverbins %>%
  ungroup() %>%
  group_by(fish_id) %>%
  mutate(total_turns = sum(x)) %>%
  dplyr::select(colnames(meta), total_turns) %>% 
  unique  %>%
  ungroup %>% 
  glmer.nb(total_turns ~ genotype + tank + sex + (1|start_time),
         data = .)

Anova(glm_timebyturns2) %>% 
  signif(digits = 2) %>% 
  kable %>% 
  kable_styling(full_width = F) %>% 
  row_spec(color = "red", row = c(1, 3))

print(emmeans(glm_timebyturns2, ~ genotype), type = "response") %>% 
  as_tibble() %>% 
  ggplot(aes(x = genotype, y = response, colour = genotype)) +
  geom_col(aes(fill = genotype), 
           alpha = 0.5,
           width = 0.75,
           position = position_dodge()) +
  geom_errorbar(aes(ymin = asymp.LCL, ymax =asymp.UCL),
                width = 0.125,
                size = 1,
                position = position_dodge(width = 0.75)) +
  theme(axis.text.x = element_text(hjust = 1,
                               vjust = 1,
                               angle = 45), 
        legend.position = "bottom") +
  scale_color_viridis_d(end = 0.8, option = "inferno") +
  scale_fill_viridis_d(end = 0.8, option = "inferno") +
  labs(y = "GLM predicted total number of turns",
       x = "Genotype", 
       title = "GLM predicted total number of turns performed by zebrafish", 
       subtitle = "p = "
       )

```

## turns across the hour. 

I also want to look at whether the fish display changes to activity across the hour (i.e. are they more active when they are first placed in the maze?). 

If we compare visually just between the wt and hom fish, it looks like the wt are showing reduced activity as the test goes on, whereas the hom fish are staying more active.


```{r}
#hgsnataged_turnsacrosshour <- 
  final_data_long %>%
  dplyr::distinct(fish_id, bin, .keep_all = TRUE) %>% 
  mutate(binforvis = case_when(
    bin == 1 ~ "0-10 mins", 
    bin == 2 ~ "10-20 mins", 
    bin == 3 ~ "20-30 mins", 
    bin == 4 ~ "30-40 mins", 
    bin == 5 ~ "40-50 mins", 
    bin == 6 ~ "50-60 mins"
    )) %>% 
  ggplot(aes(x = binforvis, 
             y = total_turns)) +
  
  geom_boxplot(aes(fill = genotype,
       colour = genotype),
       position = "dodge",
           alpha = 0.2,
           outlier.shape = NA) +

  geom_point(aes(colour = genotype, fill = genotype),
              alpha = 0.7,
             position = position_jitterdodge()) +
  
  #geom_smooth(aes(group = genotype, colour = genotype, fill = genotype), se = F, size = 2.5) +
  
  geom_label_repel(aes(label = fish_id), data = . %>% 
                     dplyr::filter(total_turns>300)) +
  theme(plot.title = element_markdown(size = 14, hjust = 0.5), legend.position = "bottom") +
  scale_y_continuous(limits = c(0,250), breaks = seq(0,250,25)) +
  
  labs(title = "Number of turns performed by ***hgsnat^G577Sfs^*** zebrafish in the Y-maze across 1 hour ", 
       y = "Number of turns", x = "Time bin") +
  scale_colour_viridis_d(end = 0.75) +
  scale_fill_viridis_d(end = 0.75)

saveRDS(hgsnataged_turnsacrosshour, "data/R objects/supps/hgsnataged_turnsacrosshour.rds")
```

## statistical test

To test whether the Genotype and/or Treatment have a significant effect overall on the total number of turns, I fitted the per bin data to a negative binomial generalised linear mixed effect model. Since the start time of the test doesnt have a logical pattern (i.e. mrore active in morning), I've included it in the model as a random effect. 
The bin has a highly significant effect on the total turns. This is consistent with what we have seen in the past using this test. The fish are more active when they first enter the maze and it drops off as they become more accustomed to it. The effect of genotype is also statistically signnificant. . The genotype:treatment:bin effect 



```{r }
#saving this object out as it does not let the rmarkdown doc run.

glm_timebyturns <- final_data_long %>%
  dplyr::distinct(fish_id, bin, .keep_all = TRUE) %>%
  mutate(bin = case_when(
    bin == 1 ~ "0-10 mins",
    bin == 2 ~ "10-20 mins",
    bin == 3 ~ "20-30 mins",
    bin == 4 ~ "30-40 mins",
    bin == 5 ~ "40-50 mins",
    bin == 6 ~ "50-60 mins"
    )) %>%
   glmer.nb(total_turns ~ genotype*bin + genotype + tank + sex + (1|fish_id) + (1|start_time),
         data = .)

glm_timebyturns %>% saveRDS("/Users/admin/Desktop/R projects/MPSIII_zebrafish_Ymaze-main/data/R objects/hgsnat_aged_timebyturns_glm_fishid.rds")

# re-import this object
hgsnat_aged_timebyturns_glm_fishid <- read_rds("/Users/admin/Desktop/R projects/MPSIII_zebrafish_Ymaze-main/data/R objects/fish_id/hgsnat_aged_timebyturns_glm_fishid.rds")

#the anova chunk below gives me xml children subscript out of bounds error

#hgsnat_aged_timebyturns_glm_fishid_anova <- 
  Anova(hgsnat_aged_timebyturns_glm_fishid) %>% 
signif(digits = 3) %>%
kable %>%
kable_styling(full_width = F) #%>%
 row_spec(color = "red", row = c(1, 3, 4))

write.csv(hgsnat_aged_timebyturns_glm_fishid_anova, "/Users/admin/Desktop/R projects/MPSIII_zebrafish_Ymaze-main/data/R objects/hgsnat_aged_timebyturns_glm_fishid_anova.csv", row.names = TRUE)

print(emmeans(glm_timebyturns, ~ genotype * bin), type = "response") %>% 
  as_tibble() %>% 
  mutate(binforvis = case_when(
    bin == 1 ~ "0-10 mins", 
    bin == 2 ~ "10-20 mins", 
    bin == 3 ~ "20-30 mins", 
    bin == 4 ~ "30-40 mins", 
    bin == 5 ~ "40-50 mins", 
    bin == 6 ~ "50-60 mins"
    )) %>% 
  ggplot(aes(x = bin, y = response, colour = genotype)) +
  geom_col(aes(fill =genotype), 
           alpha = 0.75,
           position = position_dodge()) +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL),
                position = position_dodge()) +
  theme(axis.text.x = element_text(hjust = 1,
                               vjust = 1,
                               angle = 45), 
        legend.position = "bottom") +
  scale_color_viridis_d(end = 0.8, option = "inferno") +
  scale_fill_viridis_d(end = 0.8, option = "inferno") +
  labs(y = "Predicted number of turns per bin",
       x = "Time interval", 
       title = "GLM-predicted total turns per bin in hgsnat G577Sfs", 
       subtitle = "Effect of genotype*bin p = 0.99 "
       )

hgsnataged_turnsacrosshour_glm_plot_fishid <- 
 print(emmeans(hgsnat_aged_timebyturns_glm_fishid, ~ genotype * bin), type = "response") %>% 
  as_tibble() %>% 
  mutate(binforvis = case_when(
    bin == 1 ~ "0-10 mins", 
    bin == 2 ~ "10-20 mins", 
    bin == 3 ~ "20-30 mins", 
    bin == 4 ~ "30-40 mins", 
    bin == 5 ~ "40-50 mins", 
    bin == 6 ~ "50-60 mins"
    )) %>% 
  ggplot(aes(x = bin, y = response, colour = genotype)) +

  geom_point(aes(colour = genotype, fill = genotype),
              size = 5,
             position = position_dodge(width = 0.5)) +
  
  geom_errorbar(aes(ymin = asymp.LCL, ymax =asymp.UCL),
                width = 0.25,
                size = 1.3,
                position = position_dodge(width = 0.5)) +
  
  geom_smooth(aes(group = genotype, colour = genotype, fill = genotype), alpha = 0.5, se = T, size = 2) +
  
  # geom_label_repel(aes(label = fish_id), data = . %>% 
  #                    dplyr::filter(total_turns>300)) +
  theme(plot.title = element_markdown(size = 14, hjust = 0.5), plot.subtitle = element_markdown(hjust = 0.5), legend.position = "bottom") +
  scale_y_continuous(limits = c(0,175), breaks = seq(0,175,25)) +
  
  labs(title = "Model predicted number of turns performed by ***hgsnat^G577Sfs^*** zebrafish in the Y-maze across 1 hour ", 
       subtitle = "Effect of genotype * time bin p = 0.47 ", y = "Number of turns", x = "Time bin") +
  scale_colour_viridis_d(end = 0.8) +
  scale_fill_viridis_d(end = 0.8)

saveRDS(hgsnataged_turnsacrosshour_glm_plot_fishid, "data/R objects/fish_id/hgsnataged_turnsacrosshour_glm_plot_fishid.rds")


print(emmeans(hgsnat_aged_timebyturns_glm_fishid, ~ genotype), type ="response") %>% 
  as_tibble() %>% 
  ggplot(aes(x = genotype, y = response, colour = genotype)) +
  geom_col(aes(fill = genotype), 
           alpha = 0.45,
           width = 0.6,
           position = position_dodge()) +
  geom_errorbar(aes(ymin = asymp.LCL, ymax =asymp.UCL),
                width = 0.125,
                size = 1,
                position = position_dodge(width = 0.75)) +
            theme(axis.title.x = element_text(size = 18, face = "italic", margin = margin(b = 5, t = 15))) +
            theme(axis.title.y = element_text(size = 16)) +
            theme(axis.text = element_text(size = 14)) +
            theme(plot.title = element_text(size = 20, hjust = 0.5)) +
  theme(plot.subtitle = element_text(size = 16, hjust = 0.5)) +
  theme(axis.text.x = element_text(size = 18, hjust = 0.5,
                               vjust = 0.1, face = "bold"), 
        legend.position = "none") +
        theme(legend.key.size = unit(0.8, 'cm'), #change legend key size
        #legend.key.height = unit(2, 'cm'), #change legend key height
        #legend.key.width = unit(1, 'cm'), #change legend key width
        legend.title = element_text(size=14), #change legend title font size
        legend.text = element_text(size=14),#change legend text font size
        legend.margin=margin(-3, 0, 0, 0)) + 
  scale_color_viridis_d(begin = 0.01, end = 0.02, option = "inferno") +
  scale_fill_viridis_d(end = 0.75, begin = 0.25) +
  labs(y = "predicted average number of turns performed in 1 hour",
       x = "hgsnat G577Sfs", 
       title = "Activity of hgsnat G577Sfs zebrafish in a y-maze ", 
       subtitle = "Effect of genotype p = 0.022"
       )

```

## are the mutants more likely to be "non responders"

Some fish may not repsond to this test, So first I will have a look if there are any fish which seem to just sit there and not move for the whole hour. Here, I will define a fish to be a "non-responder" if they perfomed less than 60 turns in the test (so less than 1  per minuye). 

First, I will plot the totalturns per bin per fish as a line plot. There does seem to be some fish which show a relatively straight line around 10 total turns. 
```{r}
final_data %>% 
  ggplot(aes(x = bin, y = total_turns)) +
  geom_line(aes(colour = fish_id), show.legend = F) +
  facet_wrap(~genotype, nrow = 1)
```


Can use the below code to define non-responsive fish (under a certain total turn number). KB used 60 as her cutoff. 
 
```{r}
final_data %>% 
  dplyr::select(!grep(colnames(final_data), pattern = "[L|R]{4}")) %>% #unsleect the tetras cols to make my life easier right now. 
  group_by(fish_id) %>% 
  mutate(nonresp = sum(total_turns) < 30) %>% 
  dplyr::select(fish_id, nonresp) %>% 
  unique %>% 
  dplyr::filter(nonresp == TRUE) %>% 
  left_join(meta %>% dplyr::select(fish_id, genotype)) %>% 
  kable %>% 
  kable_styling(full_width = F)
```


# time spent in each zone of the Y-maze

I next will assess whether fish in each maze spend more or less time in each zone of the Y-maze (i.e. in each arm of the maze or the middle). This is also kind of representitve of locomotion, as they might spend longer in each arm of the maze if the swim speed was slower. 

Less time in zone 4 (the middle zone) as expected since the area is smaller and the fish tend to just pass through.

There are a few wt and het fish that seem to have spent much less time in the middle zone 4 than other fish. 0.1 minutes is 6 seconds which isn't long over a whole hour. Should check these out

```{r}
read_csv("/Users/admin/Desktop/R projects/MPSIII_zebrafish_Ymaze-main/data/processed_data/hgsnat/aged/time_in_zone.csv") %>%
  mutate(fish_id = as.character(fish_id)) %>%
  dplyr::select(fish_id, bin, zone, time_in_zone) %>% 
  left_join(meta) %>%
  dplyr::filter(genotype %in% c("wt", "het", "hom")) %>% 
  dplyr::filter(zone %in% c(1:4)) %>% 
  group_by(fish_id, zone) %>%
  mutate(total_timeInZone = sum(time_in_zone), 
         zone = paste0("zone ", zone)) %>%
  dplyr::distinct(fish_id, zone, .keep_all = TRUE) %>%
  ggplot(aes(x = genotype, y = total_timeInZone/60)) +
  geom_quasirandom(aes(colour = genotype)
                  ) +
  geom_boxplot(aes(fill = genotype),
               outlier.shape = NA,
                alpha = 0.5) +
  facet_wrap(~zone, nrow = 1) +
  scale_y_log10() +
  scale_fill_viridis_d(end = 0.75) +
  scale_colour_viridis_d(end = 0.75) +
  easy_rotate_x_labels(angle = -45) +
  labs(y = "Total time spent in each zone (mins, log scale)", 
       title = "Total time spent in each zone")
```

I was curious to see whether which maze the fish were in (i.e. top left, middle etc) would have an effect on whether they spend more or less time in one of the arms of the mazes. There are 8 ymazes in each zantiks unit. inspection of the total time spent in each zone of the maze across the 8 possible positions in the zantiks unit didnt reveal any trends. 

Some arena_positions seem to have more fish doing weird stuff: arena_positions 2,3 and 7

```{r}
read_csv("/Users/admin/Desktop/R projects/MPSIII_zebrafish_Ymaze-main/data/processed_data/hgsnat/aged/time_in_zone.csv") %>%
  mutate(fish_id = as.character(fish_id)) %>%
  dplyr::select(fish_id, bin, zone, time_in_zone) %>%
  left_join(meta) %>%
  dplyr::filter(genotype %in% c("wt", "het", "hom")) %>% 
  dplyr::filter(zone %in% c(1:4)) %>% 
  group_by(fish_id, zone) %>%
  mutate(total_timeInZone = sum(time_in_zone), 
         zone = paste0("zone ", zone)) %>%
  dplyr::distinct(total_timeInZone, .keep_all = TRUE) %>%
  ggplot(aes(x = zone, y = total_timeInZone/60)) +
  geom_quasirandom(aes(colour = genotype), 
                   size = 2
                  ) +
  geom_boxplot(aes(fill = genotype),
               outlier.shape = NA,
                alpha = 0.5) +
  facet_wrap(~arena_position) +
  scale_y_log10() +
  scale_fill_viridis_d(end = 0.75) +
  scale_colour_viridis_d(end = 0.75) +
  easy_rotate_x_labels(angle = -45) +
  labs(y = "Total time spent in each zone (mins, log scale)", 
       title = "Total time spent in each zone", 
       subtitle = "according to position in the ymaze")
```

I alslo wanted to look at the average time spent in each zone. 

```{r}
read_csv("/Users/admin/Desktop/R projects/MPSIII_zebrafish_Ymaze-main/data/processed_data/hgsnat/aged/time_in_zone.csv") %>%
  mutate(fish_id = as.character(fish_id)) %>%
  dplyr::select(fish_id, bin, zone, time_in_zone) %>%
  left_join(meta) %>%
  group_by(fish_id, zone) %>%
  dplyr::filter(genotype %in% c("wt", "het", "hom")) %>% 
  dplyr::filter(zone %in% c(1:4)) %>% 
  mutate(aveTimeInZone = mean(time_in_zone), 
         zone = paste0("zone ", zone)) %>%
  dplyr::distinct(aveTimeInZone, .keep_all = TRUE) %>%
  ggplot(aes(x = genotype, y =aveTimeInZone)) +
  geom_quasirandom(aes(colour = genotype)
                  ) +
  geom_boxplot(aes(fill = genotype),
               outlier.shape = NA,
                alpha = 0.5) +
  facet_wrap(~zone, nrow = 1) +
  scale_y_log10() +
  scale_fill_viridis_d(end = 0.75) +
  scale_colour_viridis_d(end = 0.75) +
  easy_rotate_x_labels(angle = -45) +
  labs(y = "Average time spent in each zone (mins, log scale)", 
       title = "Average time spent in each zone")

```

## Statistical test

Here, I fit the average time spent in each zone of the maze to a linear mixed effect model. The `Genotype x treatmetn x zone` effect is not significant, meaning there is not difference between the mutants and Treatment groups. 

```{r}

fit <- read_csv("/Users/admin/Desktop/R projects/MPSIII_zebrafish_Ymaze-main/data/processed_data/hgsnat/aged/time_in_zone.csv") %>%
  mutate(fish_id = as.character(fish_id)) %>%
  #dplyr::filter(!(fish_id %in% fish2omit)) %>% 
  dplyr::filter(time_in_zone >=0) %>%  # omit the buggy shit with the negative times
  dplyr::select(fish_id, bin, zone, time_in_zone) %>% 
  left_join(meta) %>%
  dplyr::filter(genotype %in% c("wt", "het", "hom")) %>% 
  dplyr::filter(zone %in% c(1:4)) %>% 
  group_by(fish_id, zone) %>%
  mutate(total_timeInZone = sum(time_in_zone),
         logtimezone = log(total_timeInZone),
         zone = paste0("zone ", zone)) %>%
  dplyr::distinct(fish_id, zone, .keep_all = TRUE) %>% 
  lmer(logtimezone ~ (genotype + zone)^3 + arena_position + (1|`start_time`),
    data = .)


Anova(fit) %>% 
  signif(2) %>% 
  kable(caption = "linear mixed model: time_in_zone ~ (Genotype + zone)^2 + (1|`start_time`)" ) %>%
 # kableExtra::row_spec(row = 8, bold = TRUE) %>% 
  kable_styling(full_width = FALSE)

```

# check for handedness

Fontana et al. (https://doi.org/10.1007/s10071-019-01296-9, Matt Parker's group) showed that fish sometimes show a behavioural lateralisation (i.e. handedness). If fish show this, then they would perform less alternation tetragrams not due to working memory.

The plot below circles each of the L_R bias groups. 

```{r}
# make the LR bias object
LR_Bias <- final_data %>%
  dplyr::select(L, R, total_turns, fish_id) %>%
  group_by(fish_id) %>%
  mutate(L = sum(L),
         R = sum(R),
         total_turns = sum(total_turns),
         L_R_bias = case_when( #consider more than 60% of the time performing a left or right turn to be a bias
           L/total_turns > 0.6 ~ "Left",
           R/total_turns > 0.6 ~ "Right",
           TRUE ~ "Neither"
         )) %>%
  dplyr::select(fish_id, L_R_bias) %>%
  unique() %>%
  mutate(L_R_bias = factor(L_R_bias,
                           levels = c("Neither", "Left", "Right"))
  )
```


```{r}
ggarrange(
final_data %>%
  left_join(LR_Bias) %>%
  group_by(fish_id) %>%
  mutate(L = sum(L),
         R = sum(R),
         total_turns = sum(total_turns)
  ) %>%
  ggplot(aes(L, R)) +
  geom_point(aes(shape = L_R_bias, colour = genotype),
             size = 4) +
  geom_mark_ellipse(aes(fill = L_R_bias, label = L_R_bias),
                 alpha = 0.2, 
                 con.cap = 0) +
  labs(title = "By Genotype") +
  scale_color_viridis_d(end = 0.75) +
  theme(legend.position = "left", 
        aspect.ratio = 1) +
  scale_fill_viridis_d(option = "plasma"))

#deleted Karissa's code for an identical plot only relevant for treatment group
```

The overall propotions of fish showing left, right or no bias is similar across the 4 experimental groups. 
```{r}
final_data %>%
  left_join(LR_Bias) %>%
  group_by(fish_id) %>%
  mutate(L = sum(L),
         R = sum(R),
         total_turns = sum(total_turns)
        
  ) %>% 
  ggplot(aes(x = genotype, fill = L_R_bias )) +
  geom_bar()
```

# test for changes to alternation

Cleal et al. showed that zebrafish naturally perform more of the alternation tetragrams (LRLR and RLRL) in a Y-maze. Here, we actually see more reps that alts. I will look at this more closely later. 

```{r}
hgsnataged_tetrafreq <- 
  final_data_summedoverbins %>%
  dplyr::distinct(x, .keep_all = T) %>%
  ggplot(aes(x = tetras, y = x)) +
  geom_jitter(aes(colour = tetras,
                  shape = sex)) +
  geom_boxplot(outlier.shape = NA,
               fill = NA
               ) +
  scale_fill_viridis_d() +
  labs(y = "Number of tetragrams",
       colour = "Tetragram",
       x = "Tetragram")+
  theme(legend.position = "bottom")  +
  theme(plot.title = element_markdown(size = 14, hjust = 0.5), plot.subtitle = element_markdown(hjust = 0.5)) +
        labs(title = "Tetragram frequency of ***hgsnat^G577Sfs^*** zebrafish in the Y-maze during 1 hour ", y = "tetragram frequency")

 saveRDS(hgsnataged_tetrafreq, "data/R objects/supps/hgsnataged_tetrafreq.rds")
```

We can also overlay the genotype boxplots as shown below. 

```{r}
final_data_summedoverbins %>%
  ggplot(aes(x = tetras, y = x)) +
  geom_jitter(aes(colour = tetras,
                  shape = sex)) +
  geom_boxplot(outlier.shape = NA,
               aes(fill = genotype),
               alpha = 0.5,
               ) +
  scale_fill_viridis_d() +
  labs(y = "Number of tetragrams",
       colour = "Tetragram",
       x = "Tetragram")+
  theme(legend.position = "bottom")  +
  easy_rotate_x_labels(angle = -45) +
  annotate("rect", # add some boxes aeround the alts 
           xmin = 5.5, xmax = 6.5, 
           ymin = -1, ymax = 600, 
             alpha = 0, color= "red") +
  annotate("rect", 
           xmin = 10.5, xmax = 11.5, 
           ymin = -1, ymax = 200,
           alpha = 0, color= "red") +
  ggtitle("Total number of 16 possible tetragrams performed by zebrafish in a Y-maze\nduring a 1 hour search period") 
```

The alternation tetragrams are the tetragram of interest (the measure of working memory). Below indicates the number of tetragrams performed by zerbafish across the 6 x 10 min blocks of the hour they spent in the maze.

```{r}
final_data_long %>%
  dplyr::distinct(fish_id, bin, .keep_all = T) %>%
  mutate(binforvis = case_when(
    bin == 1 ~ "0-10 mins", 
    bin == 2 ~ "10-20 mins", 
    bin == 3 ~ "20-30 mins", 
    bin == 4 ~ "30-40 mins", 
    bin == 5 ~ "40-50 mins", 
    bin == 6 ~ "50-60 mins"
    )) %>% 
  ggplot(aes(x = genotype, y = alts)) +
  geom_boxplot(outlier.shape = NA,
               aes(fill = genotype), 
               alpha = 0.5) +
  geom_point(aes(colour = genotype), 
             position = position_jitterdodge()) +
  facet_wrap(~binforvis, nrow = 1) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
        legend.position = "bottom") +
  ylab("Frequency of alternation tetragrams (LRLR + RLRL)") +
  scale_colour_viridis_d(end = 0.75) +
  scale_fill_viridis_d(end = 0.75) 
  
```

We can also display this as the *relative* amount of alternation tetragrams performed by zebrafish in a 1 hour search period. This will control for how active each fish is. Again, fish 18 and 24 looks like outliers.

```{r}
final_data_long %>%
  dplyr::distinct(fish_id, bin, .keep_all = T) %>%
  mutate(binforvis = case_when(
    bin == 1 ~ "0-10 mins", 
    bin == 2 ~ "10-20 mins", 
    bin == 3 ~ "20-30 mins", 
    bin == 4 ~ "30-40 mins", 
    bin == 5 ~ "40-50 mins", 
    bin == 6 ~ "50-60 mins"
    )) %>% 
  ggplot(aes(x = genotype, y = rel_alts)) +
  geom_boxplot(outlier.shape = NA,
               aes(fill = genotype), 
               alpha = 0.5) +
  geom_point(aes(colour = genotype), 
             position = position_jitterdodge()) +
  facet_wrap(~binforvis, nrow = 1) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
        legend.position = "bottom") +
  ylab("Relative number of alternation tetragrams\n(LRLR + RLRL) / total_turns") +
  scale_colour_viridis_d(end = 0.75) +
  scale_fill_viridis_d(end = 0.75) 
```

KB: Finally, I will now test for alternation changes using a generalised linear mixed effect model (beta-binomial distribution). We use this because it is count data which is over-dispersed, and fixed and random effects are included. The link function is logit.

No significant effects are observed on working memory. Only the `L_R_bias` term is significant, this is to be expected, as they would probably be performing more repitiions. 

The `bin:Genotype` effect is close (ish) to statistical significance. Meaning that this might have something there. but this does not take into account the Treatment group.   

Note that I have ignored the effect of Sex here. We have never really seen a Sex effect in all of our ymaze analyses.

EG:

```{r}
hgsnataged_alts_glm <-
  final_data %>%
  left_join(LR_Bias) %>%
  mutate(
    non_alts = total_turns - alts,
    bin = as.factor(bin)
  ) %>%
  glmmTMB(
    cbind(alts, non_alts) ~ (bin + genotype)^2 + tank + sex + L_R_bias + (1|start_time) + (1|fish_id),
    family = betabinomial(),
    data = .
  )

hgsnataged_alts_glm %>% saveRDS("/Users/admin/Desktop/R projects/MPSIII_zebrafish_Ymaze-main/data/R objects/hgsnataged_alts_glm.rds")

hgsnataged_alts_glm_anova <- Anova(hgsnataged_alts_glm) %>% signif(digits = 3)
  #%>%
  # dplyr::rename(pval = `Pr(>Chisq)`) %>%
  # kable() %>%
  # kable_styling(full_width = FALSE) %>% 
  # row_spec(row = 4, bold = TRUE)

write.csv(hgsnataged_alts_glm_anova, "/Users/admin/Desktop/R projects/MPSIII_zebrafish_Ymaze-main/data/R objects/hgsnataged_alts_glm_anova.csv", row.names = TRUE)
```

## Vis 

### genotype 



```{r}
print(emmeans(glm, ~ genotype), type = "response") %>% 
  as_tibble() %>% 
  ggplot(aes(x = genotype, y = prob)) +
  geom_col(aes(fill = genotype), 
           alpha = 0.5,
           width = 0.75,
           position = position_dodge()) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL),
                width = 0.125,
                size = 1,
                position = position_dodge(width = 0.75)) +
  theme(axis.text.x = element_text(hjust = 1,
                               vjust = 1,
                               angle = 45), 
        legend.position = "bottom") +
  scale_color_viridis_d(end = 0.8, option = "inferno") +
  scale_fill_viridis_d(end = 0.8, option = "inferno") +
  labs(y = "Estimated probability of alternation\n(LRLR + RLRL)",
       x = "genotype", 
       title = "GLM predicted probability of zebrafish performing an alternation\ntetragram due to Genotype", 
       subtitle = "p = 0.11"
       )
```


### bin x Genotype x Treatment



```{r}
print(emmeans(glm, ~ genotype * bin), type = "response") %>% 
  as_tibble() %>% 
  mutate(binforvis = case_when(
    bin == 1 ~ "0-10 mins", 
    bin == 2 ~ "10-20 mins", 
    bin == 3 ~ "20-30 mins", 
    bin == 4 ~ "30-40 mins", 
    bin == 5 ~ "40-50 mins", 
    bin == 6 ~ "50-60 mins"
    )) %>% 
  ggplot(aes(x = binforvis, y = prob, colour = genotype)) +
  geom_col(aes(fill = genotype), 
           alpha = 0.5,
           # width = 0.75,
           position = position_dodge()) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL),
                # width = 0.125,
                size = 1,
                position = position_dodge()) +
  facet_wrap(~genotype, nrow = 1) +
  theme(axis.text.x = element_text(hjust = 1,
                               vjust = 1,
                               angle = 45), 
        legend.position = "bottom") +
  scale_color_viridis_d(end = 0.8, option = "inferno") +
  scale_fill_viridis_d(end = 0.8, option = "inferno") +
  labs(y = "Estimated probability of alternation\n(LRLR + RLRL)",
       x = "Time interval", 
       title = "GLM predicted probability of zebrafish performing an alternation\ntetragram due to Genotype", 
       subtitle = "p = 0.076"
       )
```

### L or R bias
```{r}
print(emmeans(glm, specs = "L_R_bias"), type = "response") %>%
  as_tibble() %>%
  ggplot(aes(L_R_bias, prob, colour = L_R_bias)) +
  geom_col(aes(fill = L_R_bias),
           alpha = 0.5,
           position = position_dodge(width = 0.5)) +
  geom_errorbar(
    aes(ymin = lower.CL, ymax = upper.CL),
    width = 0.25,
    size = 1,
    position = position_dodge(width = 0.25)
    ) +
  ylab("Estimated probability of alternation") +
  xlab("Time interval") +
  theme(
    axis.text.x = element_text(hjust = 1,
                               vjust = 1,
                               angle = 45)
    ) +
  scale_y_continuous(limits = c(0,0.25)) +
  scale_color_viridis_d(end = 0.8, option = "viridis") +
  scale_fill_viridis_d(end = 0.8, option = "viridis") +
  ggtitle("GLM predicted probability of zebrafish performing an alternation\ntetragram due to having a LR bias",
          subtitle = "Effect of L or R Bias p = 0.000000")
```

# test for changes in repetitions

Repetitions are a sign of stress. Matt Parker says he sees increased repetitions when fish are pre-treated with a chemogenic stressor. Looking at the total number of tetragrams performed, our fish in this exp seem to be performing more reps.  

```{r}
final_data_summedoverbins %>%
  dplyr::distinct(fish_id, tetras, .keep_all = T) %>%
  ggplot(aes(x = tetras, y = x)) +
  geom_jitter(aes(colour = tetras,
                  shape = sex)) +
  geom_boxplot(outlier.shape = NA,
               fill = NA
               ) +
  scale_fill_viridis_d() +
  labs(y = "Number of tetragrams",
       colour = "Tetragram",
       x = "Tetragram")+
  theme(legend.position = "none")  +
  ggtitle("Total number of 16 possible tetragrams performed by zebrafish in a Y-maze\nduring a 1 hour search period") 
```

Same graph but overlaid genotypes
```{r}
final_data_summedoverbins %>%
  ggplot(aes(x = tetras, y = x)) +
  geom_jitter(aes(colour = tetras,
                  shape = sex)) +
  geom_boxplot(outlier.shape = NA,
               aes(fill = genotype),
               alpha = 0.5,
               ) +
  scale_fill_viridis_d() +
  labs(y = "Number of tetragrams",
       colour = "Tetragram",
       x = "Tetragram")+
  theme(legend.position = "bottom")  +
  easy_rotate_x_labels(angle = -45) +
  annotate("rect", # add some boxes around the reps 
           xmin = 0.5, xmax = 1.5, 
           ymin = -1, ymax = 600, 
             alpha = 0, color= "red") +
  annotate("rect", 
           xmin = 15.5, xmax = 16.5, 
           ymin = -1, ymax = 600,
           alpha = 0, color= "red") +
  ggtitle("Total number of 16 possible tetragrams performed by zebrafish in a Y-maze\nduring a 1 hour search period") 
```

```{r}
final_data_long %>%
  dplyr::distinct(fish_id, bin, .keep_all = T) %>%
  mutate(binforvis = case_when(
    bin == 1 ~ "0-10 mins", 
    bin == 2 ~ "10-20 mins", 
    bin == 3 ~ "20-30 mins", 
    bin == 4 ~ "30-40 mins", 
    bin == 5 ~ "40-50 mins", 
    bin == 6 ~ "50-60 mins"
    )) %>% 
  ggplot(aes(x = genotype, y = reps)) +
  geom_boxplot(outlier.shape = NA,
               aes(fill = genotype), 
               alpha = 0.5) +
  geom_point(aes(colour = genotype), 
             position = position_jitterdodge()) +
  facet_wrap(~binforvis, nrow = 1) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
        legend.position = "bottom") +
  ylab("Frequency of repetition tetragrams (LLLL + RRRR)") +
  scale_colour_viridis_d(end = 0.75) +
  scale_fill_viridis_d(end = 0.75) 
  
```

We can also display this as the *relative* amount of repetition tetragrams performed by zebrafish in a 1 hour search period. This will control for how active each fish is.

```{r}
final_data_long %>%
  dplyr::distinct(fish_id, bin, .keep_all = T) %>%
  mutate(binforvis = case_when(
    bin == 1 ~ "0-10 mins", 
    bin == 2 ~ "10-20 mins", 
    bin == 3 ~ "20-30 mins", 
    bin == 4 ~ "30-40 mins", 
    bin == 5 ~ "40-50 mins", 
    bin == 6 ~ "50-60 mins"
    )) %>% 
  ggplot(aes(x = genotype, y = rel_reps)) +
  geom_boxplot(outlier.shape = NA,
               aes(fill = genotype), 
               alpha = 0.5) +
  geom_point(aes(colour = genotype), 
             position = position_jitterdodge()) +
  facet_wrap(~binforvis, nrow = 1) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
        legend.position = "bottom") +
  ylab("Relative number of repetition tetragrams\n(LLLL + RRRR) / total_turns") +
  scale_colour_viridis_d(end = 0.75) +
  scale_fill_viridis_d(end = 0.75) 
```

I fitted the over-bins data to another generalised linear mixed effect model (beta-binomial distribution), this time compariing the reps vs non-reps (LLLL + RRRR). 

Only the LR Bias term is significant. This is also expected. 

```{r}
hgsnat_aged_glm_reps <- final_data %>%
  left_join(LR_Bias) %>%
  mutate(
    non_reps = total_turns - reps,
    bin = as.factor(bin)
  ) %>%
  glmmTMB(
    cbind(reps, non_reps) ~ (bin + genotype)^2 + tank + sex + L_R_bias + (1|start_time) + (1|fish_id),
    family = betabinomial(),
    data = .
  )

hgsnat_aged_glm_reps %>%
  Anova() %>%
  dplyr::rename(pval = `Pr(>Chisq)`) %>%
  kable() %>%
  kable_styling(full_width = FALSE) %>% 
  row_spec(row = 4, bold = TRUE)

hgsnat_aged_glm_reps_anova <- Anova(hgsnat_aged_glm_reps) 
  #%>%
  # dplyr::rename(pval = `Pr(>Chisq)`) %>%
  # kable() %>%
  # kable_styling(full_width = FALSE) %>% 
  # row_spec(row = 4, bold = TRUE)

write.csv(hgsnat_aged_glm_reps_anova, "/Users/admin/Desktop/R projects/MPSIII_zebrafish_Ymaze-main/data/R objects/hgsnat_aged_glm_reps_anova.csv", row.names = TRUE)
```

### genotype



```{r}
print(emmeans(glm_reps, ~ genotype), type = "response") %>% 
  as_tibble() %>% 
  ggplot(aes(x = genotype, y = prob)) +
  geom_col(aes(fill = genotype), 
           alpha = 0.5,
           width = 0.75,
           position = position_dodge()) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL),
                width = 0.125,
                size = 1,
                position = position_dodge(width = 0.75)) +
  theme(axis.text.x = element_text(hjust = 1,
                               vjust = 1,
                               angle = 45), 
        legend.position = "bottom") +
  scale_color_viridis_d(end = 0.8, option = "inferno") +
  scale_fill_viridis_d(end = 0.8, option = "inferno") +
  labs(y = "Estimated probability of repetitions\n(LLLL + RRRR)",
       x = "Genotype", 
       title = "GLM predicted probability of zebrafish performing an repetition tetragram due to Genotype", 
       subtitle = "effect of genotype p = 0.044"
       )
```

## effect of Genotype x  bin

```{r, fig.height=10}
print(emmeans(glm_reps, ~ genotype * bin), type = "response") %>% 
  as_tibble() %>% 
  mutate(binforvis = case_when(
    bin == 1 ~ "0-10 mins", 
    bin == 2 ~ "10-20 mins", 
    bin == 3 ~ "20-30 mins", 
    bin == 4 ~ "30-40 mins", 
    bin == 5 ~ "40-50 mins", 
    bin == 6 ~ "50-60 mins"
    )) %>% 
  ggplot(aes(x = binforvis, y = prob, colour = genotype)) +
  geom_col(aes(fill =genotype), 
           alpha = 0.75,
           position = position_dodge()) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL),
                position = position_dodge()) +
  theme(axis.text.x = element_text(hjust = 1,
                               vjust = 1,
                               angle = 45), 
        legend.position = "bottom") +
  scale_color_viridis_d(end = 0.8, option = "inferno") +
  scale_fill_viridis_d(end = 0.8, option = "inferno") +
  labs(y = "Estimated probability of alternation\n(LRLR + RLRL)",
       x = "Time interval", 
       title = "GLM predicted probability of zebrafish performing an repetition tetragram due to Genotype and bin", 
       subtitle = "Effect of genotype*bin p = 0.17"
       )
```

## L or R bias
```{r}
print(emmeans(glm_reps, specs = "L_R_bias"), type = "response") %>%
  as_tibble() %>%
  ggplot(aes(L_R_bias, prob, colour = L_R_bias)) +
  geom_col(aes(fill = L_R_bias),
           alpha = 0.5,
           position = position_dodge(width = 0.5)) +
  geom_errorbar(
    aes(ymin = lower.CL, ymax = upper.CL),
    width = 0.25,
    size = 1,
    position = position_dodge(width = 0.25)
    ) +
  ylab("Estimated probability of alternation") +
  xlab("Time interval") +
  theme(
    axis.text.x = element_text(hjust = 1,
                               vjust = 1,
                               angle = 45)
    ) +
  scale_y_continuous(limits = c(0,0.5)) +
  scale_color_viridis_d(end = 0.8, option = "viridis") +
  scale_fill_viridis_d(end = 0.8, option = "viridis") +
  ggtitle("GLM predicted probability of zebrafish performing an repetition tetragram due to having a LR bias",
          subtitle = "Effect of L or R Bias p = 0.000000\naveraged out over Genotypes and bins")
```


# Conclusion


```{r}
# export data for later:
final_data %>% 
  saveRDS("/Users/admin/Desktop/R projects/MPSIII_zebrafish_Ymaze-main/data/R objects/hgsnat_aged.rds")
```


```{r}
# export glmTMB for combined alternation plot:
glm %>% 
  saveRDS("/Users/admin/Desktop/R projects/MPSIII_zebrafish_Ymaze-main/data/R objects/hgsnat_aged_glm.rds")
```

#ggsave(filename = "sgshupdatedcombined.svg", path = "output/ZF presentation", width = 12, height = 6, dpi = 300)

